{% extends 'marer/layout.html' %}

{% load staticfiles %}

{% block head_additional %}
    <link href="{% static '/marer/css/vertical-center.css' %}" rel="stylesheet">
    <link href="{% static '/marer/css/no-text-decoration.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
    <div class="jumbotron vertical-center">
        <div class="container">
            <div class="row">
                <div class="col-md-4 col-md-offset-4">
                    <div class="text-center">
                        <a href="{% url 'index' %}" class="no-text-decoration">
                            <img src="{% static 'marer/img/logo_sgb.png' %}" height="50"/>
                        </a>
                        <br/>
                        <br/>
                        <br/>
                    </div>
                    <ul class="nav nav-tabs nav-justified">
                        <li class="{% if request.resolver_match.url_name == 'login' %}active bg-primary{% endif %}"><a href="{% url 'login' %}">Имя и пароль</a></li>
                        <li class="{% if request.resolver_match.url_name == 'login_sign' %}active bg-primary{% endif %}"><a href="{% url 'login_sign' %}">Цифровая подпись</a></li>
                    </ul>
                    <div class="panel panel-primary">
                        <div class="panel-body">
                            <div class="h3 text-center text-uppercase">Вход</div>
                            <br/>
                            <form method="post">
                                {% csrf_token %}
                                <div class="form-row">
                                    <div class="form-group col-md-12">
                                        <label class="control-label">{{ login_form.cert.label }}</label>
                                        {{ login_form.cert }}
                                    </div>
                                </div>
                                {{ login_form.signature }}
                                {% include 'marer/form_errors.html' with form=login_form %}
                                <button type="submit" id="btn-login" class="btn btn-primary center-block">Войти</button>
                            </form>
                        </div>
                    </div>
{#                    <a class="btn btn-link pull-right" href="{% url 'password_reset_request' %}" role="button">Восстановить пароль</a>#}
                </div>
            </div>
        </div>
    </div>

    <script>
        window.CryptoProConfig = {
            publicPath: "{% static '/crypto-pro/dist/' %}"
        };
    </script>
    <script src="{% static '/crypto-pro/example/polyfills/addEventListener.js' %}" type="text/javascript"></script>
    <script src="{% static '/crypto-pro/example/polyfills/promise.js' %}" type="text/javascript"></script>
    <script src="{% static '/crypto-pro/example/polyfills/forEach.js' %}" type="text/javascript"></script>
    <script src="{% static '/crypto-pro/example/polyfills/map.js' %}" type="text/javascript"></script>
    <script src="{% static '/crypto-pro/dist/crypto-pro.js' %}" type="text/javascript"></script>
    <script src="{% static '/crypto-pro/example/polyfills/atob-btoa.js' %}" type="text/javascript"></script>
    <script type="text/javascript">
        var $certs = document.querySelector('#id_cert');
        var $signatureCnt = document.querySelector('#id_signature');
        var $btn = document.querySelector('#btn-login')
        var hash = 'b285056dbf18d7392d7677369524dd14747459ed8143997e163b2986f92fd42c';
        var hashBase64 = window.btoa(hash);

        function updateSign() {
            var thumbprint = $certs.value;
            $btn.disabled = true;

            window.CryptoPro.call('signData', thumbprint, hashBase64).then(function (signature) {
                $signatureCnt.value = signature;
                $btn.disabled = false;
            });
        }

        $certs.addEventListener('change', updateSign)

        window.CryptoPro.call('getCertsList').then(function (list) {
            list.forEach(function (cert) {
                var $certOption = document.createElement('option');

                if (typeof $certOption.textContent !== 'undefined') {
                    $certOption.textContent = cert.label;
                } else {
                    $certOption.innerText = cert.label;
                }

                $certOption.value = cert.thumbprint;

                $certs.appendChild($certOption);
            });
            updateSign();
        }, function (error) {
            console.error(error);
        });
    </script>
{#    <script src="{% static '/marer/js/cert-list.js' %}" type="text/javascript"></script>#}
{% endblock %}
